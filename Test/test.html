<html>
  <head>
    <title>JSC3L demo</title>
    <script type="text/javascript" src="./test-master.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <div class="left">
      <div id="password">
        <label for="password">Wallet password:</label>
        <input type="password" id="psw" name="psw"><br/>
        <input type="submit" value="Unlock wallet" onClick="unlock();">
      </div>

      <div id="balance">
        Account:<br/>
        <div>
          <div id="blockie" class="blockie"></div>
        </div>
        <input id="address" type="text" name="address" readonly="readonly" />
        <br/>
        <br/>

        <label for="amount">Balance:</label>
        <input type="text" id="amount" name="amount" readonly="readonly" />
        <br/>
      </div>
      <br/>
      <br/>

      <div id="transactions"></div>
      <br/>
      <div id="payment">
        Payment of 0.01 to:<br/>
        <div id="blockieTo" class="blockie"></div>
        <input type="text" id="addressTo" name="addressTo" readonly="readonly" />
        <br/>
        <label for="memo">Memo:</label> <br/>
        <input type="text" id="memo" name="memo"/>
        <input type="hidden" id="key_message" name="key_message"/>
        <br/>
        <br/>
        <input type="submit" id="payer" name="payer" value="Payer" onClick="pay();">

      </div>
    </div>
    <div class="right">
      <div id="message"></div>
    </div>
    <script type="text/javascript">

     var $ = function (...args) { return document.getElementById(...args); };
     var $msg = $("message");


     var readWallet = function() {
         return new Promise(function (resolve, reject) {
             var xobj = new XMLHttpRequest();
             xobj.overrideMimeType("application/json");
             xobj.open('GET', 'wallet.json', true);
             xobj.onreadystatechange = function () {
                 if (xobj.readyState == 4 && xobj.status == "200") {
                     resolve(xobj.responseText);
                 }
             };
             xobj.send(null);
         });
     };


     function log(msg) { $msg.innerHTML += "\n" + msg; }


     async function init () {

         log("Retrieve repository...");
         await jsc3l.connection.ensureComChainRepo();

         log("Acquire ComChain endpoint...");
         await jsc3l.connection.acquireEndPoint();

         log("Retrieving account...");

         json_wallet = await readWallet();

         let name_currency = JSON.parse(json_wallet).server.name;

         log("Currency customization...");
         await jsc3l.customization.getConfJSON(name_currency);

         $("password").style.display = "inline-block";
         log("Waiting for wallet password...");

     }

     var json_wallet = "";
     var local_wallet = {};


     var getTransactionMemo = function(transaction) {
         let key = jsc3l_message().messageKeysFromCrypted(local_wallet, local_wallet.message_key.priv).clear_priv;

         let memo = ""
         if (transaction.addr_to.toLowerCase() == local_wallet.getAddressString().toLowerCase() &&
             transaction.message_to != '' &&
             transaction.message_to) {
             memo = jsc3l_message().decipherMessage(key, "" + transaction.message_to);
         }

         if (transaction.addr_from.toLowerCase() == local_wallet.getAddressString().toLowerCase() &&
             transaction.message_from != '' &&
             transaction.message_from) {
             memo = jsc3l_message().decipherMessage(key, transaction.message_from);
         }

         return memo;
     }


     var unlock = async function () {

         var password = $("psw").value;

         // Décryptage du wallet
         try {
             local_wallet = Wallet.getWalletFromPrivKeyFile(json_wallet, password);
             log("Unlocking account...");
         } catch (error) {
             log(`Error: ${error.message}`);
             throw error;
         }

         // vérification que la clef de message est présente
         log("Retrieval of the message key...");
         local_wallet = await jsc3l.message.ensureWalletMessageKey(local_wallet, '');

         // obtention de la balance du compte
         log("Retrieval of the balance...");
         let value = await jsc3l.bcRead.getGlobalBalance(local_wallet.getAddressString());

         $("password").style.display = "none";
         $("balance").style.display = "inline-block";
         $("amount").value = value;
         $("address").value = local_wallet.getAddressString();
         $("blockie").style.backgroundImage = 'url(' + local_wallet.blockies() +')';

         // récupération des transactions

         log("Retrieval of transactions...");

         let result = await jsc3l.ajaxReq.getTransList(local_wallet.getAddressString(), 10, 0);

         $("transactions").style.display = "inline-block";
         if (result.length == 0) {
             $("transactions").innerHTML = "No transactions yet!";
         } else {
             for (var ind = result.length - 1 ; ind >= 0 ; ind--) {
                 var data = JSON.parse(result[ind]);
                 var tr_date = new Date(data.time * 1000);
                 $("transactions").innerHTML =
                     "<div style=\"border:black solid 2px;padding:3px;\"> date:" +
                     tr_date + " <br/>De:" + data.addr_from + " <br/>A&nbsp;&nbsp;:" +
                     data.addr_to + "  <br/>montant:" + data.recieved / 100.0 +
                     " <br/> memo:" + getTransactionMemo(data) +
                     "</div><br/>" +
                     $("transactions").innerHTML;

             }

             $("transactions").innerHTML = "Last transactions:<br/>" +
                                           $("transactions").innerHTML;

         }

         log("Displaying payment bloc...");
         var address_dest = "0x77bd202703d482e9ffce1a2db571c52a6d1a5cd3";
         $("addressTo").value = address_dest;

         $("blockieTo").style.backgroundImage =
             'url(' + Wallet.blockies(address_dest) + ')';

         log("Retrieval of the message key...");

         remote_key = await jsc3l.message.getMessageKey(address_dest, false);
         if (remote_key.public_message_key !== undefined) {
             $("key_message").value = remote_key.public_message_key;
         }

         $("payment").style.display="inline-block";
     }


     var pay = async function () {

         $("payer").style.display = "none";
         log("Preparation of additional data...");

         var data = {};

         // encrypte le message
         if ($("memo").value.length > 0) {

             if ($("key_message").value.length > 0) {
                 data['memo_to'] = jsc3l_message().cipherMessage(
                     $("key_message").value,
                     $("memo").value
                 );
             }

             if (local_wallet.message_key.pub &&
                 local_wallet.message_key.pub.length > 0) {
                 data['memo_from'] = jsc3l_message().cipherMessage(
                     local_wallet.message_key.pub,
                     $("memo").value
                 );
             }
         }

         // envoie le payment

         log("Sending transaction order...");
         await jsc3l.bcTransaction.TransfertNant(local_wallet, $("addressTo").value, 0.01, data);

         log("Order sent...");
         alert("The order was sent");

         log("Refreshing balance...");
         $("amount").value = await jsc3l.bcRead.getGlobalBalance(local_wallet.getAddressString())
     }


     init();

    </script>
  </body>
</html>